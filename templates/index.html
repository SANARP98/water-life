<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scalping Strategy Manager</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            color: #667eea;
            font-size: 28px;
        }

        .status-badge {
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 14px;
        }

        .status-stopped {
            background: #ff6b6b;
            color: white;
        }

        .status-running {
            background: #51cf66;
            color: white;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 20px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-weight: 600;
            font-size: 13px;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #51cf66;
            transition: .4s;
            border-radius: 30px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #ff6b6b;
        }

        input:checked + .slider:before {
            transform: translateX(30px);
        }

        .trading-mode {
            display: flex;
            align-items: center;
            gap: 15px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .mode-label {
            font-weight: bold;
            font-size: 14px;
        }

        .mode-paper {
            color: #51cf66;
        }

        .mode-live {
            color: #ff6b6b;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #51cf66;
            color: white;
        }

        .btn-success:hover {
            background: #40c057;
        }

        .btn-danger {
            background: #ff6b6b;
            color: white;
        }

        .btn-danger:hover {
            background: #ff5252;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .position-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .position-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .position-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .position-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .position-value {
            font-size: 20px;
            font-weight: bold;
        }

        .pnl-positive {
            color: #51cf66;
        }

        .pnl-negative {
            color: #ff6b6b;
        }

        .logs-container {
            grid-column: 1 / -1;
            max-height: 400px;
        }

        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .logs-box {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 10px;
            height: 350px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 3px;
        }

        .log-timestamp {
            color: #858585;
            margin-right: 10px;
        }

        .log-info {
            color: #4ec9b0;
        }

        .log-warning {
            color: #dcdcaa;
        }

        .log-error {
            color: #f48771;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        @media (max-width: 968px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .position-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéØ Scalping Strategy Manager</h1>
            <div style="display: flex; gap: 10px; align-items: center;">
                <div class="status-badge" style="background: #667eea; color: white;" id="strategyBadge">scalping v1</div>
                <div class="status-badge" id="statusBadge">‚óè STOPPED</div>
            </div>
        </header>

        <div class="main-grid">
            <!-- Configuration Panel -->
            <div class="card">
                <h2>‚öôÔ∏è Configuration</h2>

                <div class="form-group">
                    <label>Strategy Selection</label>
                    <select id="strategySelect" onchange="onStrategyChange()">
                    </select>
                    <small id="strategyDescription" style="display: block; margin-top: 5px; color: #666; font-size: 12px;">
                        Select a strategy to view its configuration.
                    </small>
                </div>

                <div class="trading-mode">
                    <span class="mode-label">Trading Mode:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="paperTradingToggle">
                        <span class="slider"></span>
                    </label>
                    <span class="mode-label" id="modeLabel">
                        <span class="mode-paper">üìù PAPER TRADING</span>
                    </span>
                </div>

                <div id="dynamicConfig"></div>

                <div style="margin-top: 25px;">
                    <button class="btn btn-primary" onclick="saveConfig()">üíæ Save Configuration</button>
                </div>
            </div>

            <!-- Monitoring Panel -->
            <div class="card">
                <h2>üìä Monitoring</h2>

                <div class="position-card">
                    <h3 style="margin-bottom: 10px; font-size: 18px;">Current Position</h3>
                    <div class="position-grid">
                        <div class="position-item">
                            <div class="position-label">Status</div>
                            <div class="position-value" id="positionStatus">FLAT</div>
                        </div>
                        <div class="position-item">
                            <div class="position-label">Side</div>
                            <div class="position-value" id="positionSide">-</div>
                        </div>
                        <div class="position-item">
                            <div class="position-label">Entry</div>
                            <div class="position-value" id="entryPrice">-</div>
                        </div>
                        <div class="position-item">
                            <div class="position-label">Target</div>
                            <div class="position-value" id="tpLevel">-</div>
                        </div>
                        <div class="position-item">
                            <div class="position-label">Stoploss</div>
                            <div class="position-value" id="slLevel">-</div>
                        </div>
                        <div class="position-item">
                            <div class="position-label">Daily P&L</div>
                            <div class="position-value" id="dailyPnl">‚Çπ0.00</div>
                        </div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Pending Signal</div>
                        <div class="stat-value" id="pendingSignal">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Last Update</div>
                        <div class="stat-value" id="lastUpdate">-</div>
                    </div>
                </div>

                <div style="margin-top: 25px;">
                    <button class="btn btn-success" id="startBtn" onclick="startBot()">‚ñ∂Ô∏è Start Bot</button>
                    <button class="btn btn-danger" id="stopBtn" onclick="stopBot()" disabled>‚èπÔ∏è Stop Bot</button>
                </div>
            </div>

            <!-- Logs Panel -->
            <div class="card logs-container">
                <div class="logs-header">
                    <h2>üìù Activity Logs</h2>
                    <button class="btn btn-primary" onclick="clearLogs()">Clear Logs</button>
                </div>
                <div class="logs-box" id="logsBox">
                    <div class="log-entry">
                        <span class="log-timestamp">[System]</span>
                        <span class="log-info">Waiting to start...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // WebSocket connection
        const socket = io();

        const DEFAULT_SYMBOLS = ['NIFTY', 'BANKNIFTY', 'FINNIFTY', 'MIDCPNIFTY', 'NIFTYNXT50', 'SENSEX', 'BANKEX', 'SENSEX50'];

        let isRunning = false;
        let availableStrategies = [];
        let currentStrategy = 'scalping';
        let selectedStrategyId = 'scalping';
        let currentConfigValues = {};
        let symbolOptions = [];

        socket.on('connect', async function() {
            console.log('Connected to server');
            await loadStrategies();
            await loadConfig();
        });

        socket.on('log', function(data) {
            addLog(data);
        });

        socket.on('status_update', function(data) {
            updateStatus(data);
        });

        async function loadStrategies() {
            try {
                const response = await fetch('/api/strategies');
                const data = await response.json();
                availableStrategies = data.strategies || [];
                currentStrategy = data.current || (availableStrategies[0]?.id || 'scalping');
                selectedStrategyId = currentStrategy;

                const select = document.getElementById('strategySelect');
                select.innerHTML = '';
                availableStrategies.forEach(strategy => {
                    const option = document.createElement('option');
                    option.value = strategy.id;
                    option.textContent = strategy.name;
                    option.selected = strategy.id === selectedStrategyId;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading strategies:', error);
            }
        }

        function onStrategyChange() {
            selectedStrategyId = document.getElementById('strategySelect').value;
            const strategy = availableStrategies.find(s => s.id === selectedStrategyId);
            if (!strategy) {
                return;
            }

            const fallbackSymbols = Object.keys(strategy.lot_sizes || {});
            if (fallbackSymbols.length) {
                symbolOptions = fallbackSymbols;
            } else if (selectedStrategyId !== currentStrategy && !symbolOptions.length) {
                symbolOptions = DEFAULT_SYMBOLS;
            }

            const values = selectedStrategyId === currentStrategy ? currentConfigValues : (strategy.default_config || {});
            renderStrategy(selectedStrategyId, values);
        }

        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const data = await response.json();

                currentStrategy = data.selected_strategy || currentStrategy;
                selectedStrategyId = currentStrategy;
                currentConfigValues = data.config || {};
                symbolOptions = data.available_symbols && data.available_symbols.length ? data.available_symbols : DEFAULT_SYMBOLS;

                const select = document.getElementById('strategySelect');
                select.value = selectedStrategyId;

                document.getElementById('paperTradingToggle').checked = !data.is_paper_trading;
                updateModeLabel();

                renderStrategy(selectedStrategyId, currentConfigValues);
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }

        function renderStrategy(strategyId, valuesOverride) {
            const strategy = availableStrategies.find(s => s.id === strategyId);
            if (!strategy) {
                return;
            }

            document.getElementById('strategyDescription').textContent = strategy.description || '';
            document.getElementById('strategyBadge').textContent = strategy.name;

            const schema = strategy.config_schema || [];
            const defaults = strategy.default_config || {};
            const mergedValues = Object.assign({}, defaults, valuesOverride || {});

            const fallbackSymbols = Object.keys(strategy.lot_sizes || {});
            if (!symbolOptions.length && fallbackSymbols.length) {
                symbolOptions = fallbackSymbols;
            }

            buildConfigForm(schema, mergedValues);
        }

        function buildConfigForm(schema, values) {
            const container = document.getElementById('dynamicConfig');
            container.innerHTML = '';

            if (!schema.length) {
                const message = document.createElement('p');
                message.style.color = '#666';
                message.textContent = 'No editable configuration values exposed for this strategy.';
                container.appendChild(message);
                return;
            }

            let currentGroupName = '';
            let groupWrapper = null;

            schema.forEach(field => {
                const groupName = field.group || 'General';
                if (groupName !== currentGroupName) {
                    currentGroupName = groupName;

                    const heading = document.createElement('h3');
                    heading.textContent = groupName;
                    heading.style.marginTop = '20px';
                    heading.style.marginBottom = '10px';
                    heading.style.fontSize = '16px';
                    heading.style.color = '#667eea';
                    container.appendChild(heading);

                    groupWrapper = document.createElement('div');
                    groupWrapper.className = 'form-row';
                    container.appendChild(groupWrapper);
                }

                if (!groupWrapper) {
                    groupWrapper = document.createElement('div');
                    groupWrapper.className = 'form-row';
                    container.appendChild(groupWrapper);
                }

                const value = Object.prototype.hasOwnProperty.call(values, field.name) ? values[field.name] : field.default;
                const fieldElement = createFieldElement(field, value);
                groupWrapper.appendChild(fieldElement);
            });
        }

        function createFieldElement(field, value) {
            const wrapper = document.createElement('div');
            wrapper.className = 'form-group';
            const fieldId = `config-${field.name}`;
            const fieldType = field.type || 'text';
            const labelText = field.label || field.name.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());

            if (fieldType === 'boolean') {
                const checkboxGroup = document.createElement('div');
                checkboxGroup.className = 'checkbox-group';

                const input = document.createElement('input');
                input.type = 'checkbox';
                input.id = fieldId;
                input.dataset.field = field.name;
                input.checked = value !== undefined ? Boolean(value) : Boolean(field.default);

                const label = document.createElement('label');
                label.setAttribute('for', fieldId);
                label.style.marginBottom = '0';
                label.textContent = labelText;

                checkboxGroup.appendChild(input);
                checkboxGroup.appendChild(label);
                wrapper.appendChild(checkboxGroup);

                if (field.help_text) {
                    const hint = document.createElement('small');
                    hint.style.display = 'block';
                    hint.style.marginTop = '5px';
                    hint.style.color = '#888';
                    hint.textContent = field.help_text;
                    wrapper.appendChild(hint);
                }

                return wrapper;
            }

            const label = document.createElement('label');
            label.setAttribute('for', fieldId);
            label.textContent = labelText;
            wrapper.appendChild(label);

            let input;

            if (fieldType === 'select') {
                input = document.createElement('select');
                (field.options || []).forEach(optionValue => {
                    const option = document.createElement('option');
                    option.value = optionValue;
                    option.textContent = optionValue;
                    option.selected = optionValue === value;
                    input.appendChild(option);
                });
                if (!input.value && field.options && field.options.length) {
                    input.value = field.options[0];
                }
            } else {
                input = document.createElement('input');
                if (fieldType === 'number') {
                    input.type = 'number';
                    const numberFormat = field.number_format || 'float';
                    input.dataset.numberFormat = numberFormat;
                    if (field.step !== undefined) {
                        input.step = field.step;
                    } else if (numberFormat === 'int') {
                        input.step = 1;
                    } else {
                        input.step = '0.01';
                    }
                    if (field.min !== undefined) {
                        input.min = field.min;
                    }
                    if (field.max !== undefined) {
                        input.max = field.max;
                    }
                    if (value !== undefined && value !== '') {
                        input.value = value;
                    } else if (field.default !== undefined && field.default !== '') {
                        input.value = field.default;
                    }
                } else if (fieldType === 'time') {
                    input.type = 'time';
                    input.value = value || field.default || '';
                } else {
                    input.type = 'text';
                    input.value = value !== undefined ? value : (field.default || '');
                }
            }

            if (field.placeholder) {
                input.placeholder = field.placeholder;
            }

            input.id = fieldId;
            input.dataset.field = field.name;
            wrapper.appendChild(input);

            if (field.help_text) {
                const hint = document.createElement('small');
                hint.style.display = 'block';
                hint.style.marginTop = '5px';
                hint.style.color = '#888';
                hint.textContent = field.help_text;
                wrapper.appendChild(hint);
            }

            if (field.name === 'symbol') {
                const datalistId = `${fieldId}-options`;
                input.setAttribute('list', datalistId);
                const datalist = document.createElement('datalist');
                datalist.id = datalistId;

                const symbols = symbolOptions.length ? symbolOptions : DEFAULT_SYMBOLS;
                [...new Set(symbols)].forEach(sym => {
                    const option = document.createElement('option');
                    option.value = sym;
                    datalist.appendChild(option);
                });

                wrapper.appendChild(datalist);
            }

            return wrapper;
        }

        async function saveConfig() {
            const strategy = availableStrategies.find(s => s.id === selectedStrategyId);
            if (!strategy) {
                alert('‚ùå Please select a strategy.');
                return;
            }

            const schema = strategy.config_schema || [];
            const payload = {
                selected_strategy: selectedStrategyId,
                is_paper_trading: !document.getElementById('paperTradingToggle').checked
            };

            schema.forEach(field => {
                const selector = `[data-field="${field.name}"]`;
                const input = document.querySelector(selector);
                if (!input) {
                    return;
                }

                const fieldType = field.type || 'text';
                let value;

                if (fieldType === 'boolean') {
                    value = input.checked;
                } else if (fieldType === 'number') {
                    const raw = input.value;
                    if (raw === '') {
                        return;
                    }
                    const numberFormat = field.number_format || input.dataset.numberFormat || 'float';
                    value = numberFormat === 'int' ? parseInt(raw, 10) : parseFloat(raw);
                    if (Number.isNaN(value)) {
                        return;
                    }
                } else {
                    value = input.value;
                    if (fieldType === 'time' && value === '') {
                        return;
                    }
                }

                payload[field.name] = value;
            });

            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                if (data.success) {
                    alert('‚úÖ Configuration saved successfully!');
                    await loadConfig();
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå Error saving configuration: ' + error);
            }
        }

        // Start bot
        async function startBot() {
            try {
                const response = await fetch('/api/start', {method: 'POST'});
                const data = await response.json();

                if (data.success) {
                    isRunning = true;
                    updateButtons();
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå Error starting bot: ' + error);
            }
        }

        // Stop bot
        async function stopBot() {
            try {
                const response = await fetch('/api/stop', {method: 'POST'});
                const data = await response.json();

                if (data.success) {
                    isRunning = false;
                    updateButtons();
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå Error stopping bot: ' + error);
            }
        }

        // Update status display
        function updateStatus(data) {
            const statusBadge = document.getElementById('statusBadge');
            const strategyBadge = document.getElementById('strategyBadge');
            const positionStatus = document.getElementById('positionStatus');
            const positionSide = document.getElementById('positionSide');
            const entryPrice = document.getElementById('entryPrice');
            const tpLevel = document.getElementById('tpLevel');
            const slLevel = document.getElementById('slLevel');
            const dailyPnl = document.getElementById('dailyPnl');
            const pendingSignal = document.getElementById('pendingSignal');
            const lastUpdate = document.getElementById('lastUpdate');

            // Update strategy badge
            if (data.strategy) {
                const strategy = availableStrategies.find(s => s.id === data.strategy);
                if (strategy) {
                    strategyBadge.textContent = strategy.name;
                }
            }

            // Update status badge
            if (data.status === 'running') {
                statusBadge.textContent = '‚óè RUNNING';
                statusBadge.className = 'status-badge status-running';
                isRunning = true;
            } else {
                statusBadge.textContent = '‚óè STOPPED';
                statusBadge.className = 'status-badge status-stopped';
                isRunning = false;
            }

            // Update position
            positionStatus.textContent = data.in_position ? 'IN POSITION' : 'FLAT';
            positionSide.textContent = data.side || '-';
            entryPrice.textContent = data.entry_price ? data.entry_price.toFixed(2) : '-';
            tpLevel.textContent = data.tp_level ? data.tp_level.toFixed(2) : '-';
            slLevel.textContent = data.sl_level ? data.sl_level.toFixed(2) : '-';

            // Update P&L
            const pnl = data.realized_pnl_today || 0;
            dailyPnl.textContent = '‚Çπ' + pnl.toFixed(2);
            dailyPnl.className = 'position-value ' + (pnl >= 0 ? 'pnl-positive' : 'pnl-negative');

            pendingSignal.textContent = data.pending_signal || '-';
            lastUpdate.textContent = data.last_update || '-';

            updateButtons();
        }

        // Update button states
        function updateButtons() {
            document.getElementById('startBtn').disabled = isRunning;
            document.getElementById('stopBtn').disabled = !isRunning;
        }

        // Add log entry
        function addLog(data) {
            const logsBox = document.getElementById('logsBox');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';

            const levelClass = 'log-' + (data.level || 'info').toLowerCase();

            logEntry.innerHTML = `
                <span class="log-timestamp">[${data.timestamp}]</span>
                <span class="${levelClass}">${data.message}</span>
            `;

            logsBox.appendChild(logEntry);
            logsBox.scrollTop = logsBox.scrollHeight;

            // Keep only last 500 logs
            while (logsBox.children.length > 500) {
                logsBox.removeChild(logsBox.firstChild);
            }
        }

        // Clear logs
        function clearLogs() {
            document.getElementById('logsBox').innerHTML = '';
        }

        // Update mode label
        function updateModeLabel() {
            const toggle = document.getElementById('paperTradingToggle');
            const label = document.getElementById('modeLabel');

            if (toggle.checked) {
                label.innerHTML = '<span class="mode-live">üî¥ LIVE TRADING</span>';
            } else {
                label.innerHTML = '<span class="mode-paper">üìù PAPER TRADING</span>';
            }
        }

        document.getElementById('paperTradingToggle').addEventListener('change', updateModeLabel);

        // Auto-scroll logs
        setInterval(() => {
            const logsBox = document.getElementById('logsBox');
            logsBox.scrollTop = logsBox.scrollHeight;
        }, 1000);
    </script>
</body>
</html>
